.edit
  = f.error_messages
  %p
    = f.label :resident_full_name, 'Resident' , :class => :required
    - if action_name == 'edit'
      %span
        = @reservation.resident.full_name
    - else
      %span= text_field_with_auto_complete :reservation, :resident_full_name, {:class = 'bigger'}, :method = :get, :skip_style = true
      (tip: last name, first name)
    %p
      = f.label :status, {}, :class = :required
      %span
        = select f, :status, Reservation::Status.map{ |s| [s.humanize, s] }
    %p
      = f.label :arrival, {}, :class = :required
      %span
        = text_field_tag 'reservation[arrival_formatted]', @reservation.arrival_formatted, { :id = 'reservation_arrival_formatted', :onchange = dates_changed() }
        = calendar_date_select_tag reservation_arrival_formatted
    %p
      = f.label :departure, {}, :class = :required
      %span
        = text_field_tag 'reservation[departure_formatted]', @reservation.departure_formatted, { :id = 'reservation_departure_formatted', :onchange = dates_changed() }
        = calendar('reservation_departure_formatted')
    %p
      = f.label :room, {}, :class = :required
      - if %w{new create}.include?(action_name)
      - rooms   = Room.available_rooms(@reservation.arrival, @reservation.departure, @reservation.room)
      - options = rooms.map{ |room| [room.name, room.id] }
      - options = [['None available', 0]] if options.empty?
        %span
          = select(f, :room_id, options, {},                                             |
            { :onchange = remote_function(                                              |
            :method = :get,                                                             |
            :url = { :action = :ajax_room_options, :reservation_id = @reservation.id }, |
            :with = Form.Element.serialize(this)                                        |
            + 'arrival=' + $('reservation_arrival_formatted').value                     |
            + 'departure=' + $('reservation_departure_formatted').value,                |
            :before = $('spinner').show();,                                             |
            :complete = $('spinner').hide();)                                           |
            }                                                                           |
            )                                                                           |
          %span#room_total{:style => "display:inline"}
          = image_tag('spin.gif', :class = 'spinner', :id = 'spinner', :style = 'display:none;')
      - else
        %span
          = f.hidden_field :room_id
          = h @reservation.room
      :javascript
        //
        <haml_silent>       if %w{new create}.include?(action_name)
        </haml_silent><haml_block>		    document.observe("dom:loaded", function(){ $('reservation_room_id').onchange(); });
        </haml_block>
        			function dates_changed()
        			{
        <haml_silent>  		   if %w{new create}.include?(action_name)
        </haml_silent><haml_block>  				var arrival   = $('reservation_arrival_formatted').value;
          				var departure = $('reservation_departure_formatted').value;
          				if (arrival.length > 0 && departure.length > 0)
          				{
          					var selected_room_id = $('reservation_room_id')[$('reservation_room_id').selectedIndex].value
          					var reservation_id = '#{@reservation.id}';
          					new Ajax.Updater('reservation_room_id', '#{url_for(:action => :ajax_room_availables)}', {
          						asynchronous:true,
          						evalScripts:true,
          						method: 'get',
          						parameters: {
          							arrival: arrival,
          							departure: departure,
          							selected_room_id: selected_room_id,
          							reservation_id: reservation_id
          						},
          						onCreate: function(response) { Element.show('spinner') },
          						onComplete: function(response) { Element.hide('spinner') }
          					});
          				}
        </haml_block>			}
        	    //
    - if %w{new create}.include?(action_name)
      %p
        = f.label :rules
        %ul#rules
    %p
      = f.label :options
      %ul#options
        - # TODO make this DRY with a partial (in ajax_room_options too)
        - if %w{edit update}.include?(action_name)
          - @reservation.room.options.each do |option|
            - checked = @reservation.options.find_by_id(option.id) ? true : false
            - checkbox = check_box_tag('reservation[options_attributes][][room_option_id]', option.id, checked)
            = content_tag('li',  #{checkbox} #{option})
